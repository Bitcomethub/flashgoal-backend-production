app.get('/api/cron/update-scores', async (req, res) => {
  try {
    console.log('ðŸ• [CRON] Checking predictions...');
    // Aktif ve tamamlanmÄ±ÅŸ tahminleri Ã§ek (FT olunca skorlarÄ± gÃ¼ncellemek iÃ§in)
    const predictions = await pool.query(
      'SELECT * FROM predictions WHERE status IN ($1, $2)',
      ['active', 'completed']
    );

    console.log(`ðŸ“Š Found ${predictions.rows.length} predictions to check`);
    let updated = 0;
    let scoreUpdated = 0;

    for (const pred of predictions.rows) {
      try {
        // Football API'den maÃ§ skorunu Ã§ek
        const matchData = await fetch(
          `https://v3.football.api-sports.io/fixtures?id=${pred.match_id}`,
          {
            headers: {
              'x-apisports-key': process.env.FOOTBALL_API_KEY
            }
          }
        );
        
        const data = await matchData.json();
        const fixture = data.response[0];
        
        if (!fixture) {
          console.log(`âš ï¸ No fixture found for match_id: ${pred.match_id}`);
          continue;
        }
        
        const statusShort = fixture.fixture.status.short;
        const homeGoals = fixture.goals.home ?? null;
        const awayGoals = fixture.goals.away ?? null;
        
        // API'den skor gelmiyorsa logla
        if (homeGoals === null || awayGoals === null) {
          console.log(`âš ï¸ Match ${pred.match_id} - Goals are null: home=${homeGoals}, away=${awayGoals}, status=${statusShort}`);
        }
        
        const homeScore = homeGoals !== null ? homeGoals : 0;
        const awayScore = awayGoals !== null ? awayGoals : 0;
        const total = homeScore + awayScore;
        
        const predType = pred.prediction_type.toUpperCase();
        const isFinished = ["FT", "AET", "PEN"].includes(statusShort);
        const isLive = ["1H", "2H", "HT"].includes(statusShort);
        
        let result = null;
        let shouldUpdateResult = false;
        let shouldUpdateScore = false;
        
        // 1. EÄžER MAÃ‡ BÄ°TTÄ°YSE: TÃ¼m tahminlerin skorlarÄ±nÄ± gÃ¼ncelle
        if (isFinished) {
          shouldUpdateScore = true;  // Her zaman final skorlarÄ± yaz
          
          // Result henÃ¼z belirlenmemiÅŸse (active veya result=null), belirle
          if (pred.result === null || pred.status === 'active') {
            shouldUpdateResult = true;
            
            // Ä°Y tahminleri
            if (predType.includes("Ä°Y") || predType.includes("IY")) {
              const htScore = fixture.score?.halftime;
              const htTotal = htScore ? (htScore.home || 0) + (htScore.away || 0) : 0;
              
              if (predType.includes("0.5Ãœ")) result = htTotal > 0.5 ? "won" : "lost";
              else if (predType.includes("1.5Ãœ")) result = htTotal > 1.5 ? "won" : "lost";
              else if (predType.includes("2.5Ãœ")) result = htTotal > 2.5 ? "won" : "lost";
            }
            // MB tahminleri
            else if (predType.includes("MB")) {
              if (predType.includes("0.5Ãœ")) result = total > 0.5 ? "won" : "lost";
              else if (predType.includes("1.5Ãœ")) result = total > 1.5 ? "won" : "lost";
              else if (predType.includes("2.5Ãœ")) result = total > 2.5 ? "won" : "lost";
              else if (predType.includes("3.5Ãœ")) result = total > 3.5 ? "won" : "lost";
              else if (predType.includes("4.5Ãœ")) result = total > 4.5 ? "won" : "lost";
              else if (predType.includes("KGV")) result = homeScore > 0 && awayScore > 0 ? "won" : "lost";
            }
          }
        }
        
        // 2. CANLÄ° MAÃ‡TA ERKEN KAZANMA KONTROLÃœ
        else if (isLive && pred.result === null) {
          // Ä°Y tahminleri
          if (predType.includes("Ä°Y") || predType.includes("IY")) {
            if (statusShort === "HT" || statusShort === "2H") {
              const htScore = fixture.score?.halftime;
              const htTotal = htScore ? (htScore.home || 0) + (htScore.away || 0) : 0;
              
              if (predType.includes("0.5Ãœ") && htTotal > 0.5) result = "won";
              else if (predType.includes("1.5Ãœ") && htTotal > 1.5) result = "won";
              else if (predType.includes("2.5Ãœ") && htTotal > 2.5) result = "won";
              
              if (result === "won") {
                shouldUpdateResult = true;
                shouldUpdateScore = true;
              }
            }
          }
          // MB tahminleri - erken kazanma
          else if (predType.includes("MB")) {
            if (predType.includes("0.5Ãœ") && total >= 1) result = "won";
            else if (predType.includes("1.5Ãœ") && total >= 2) result = "won";
            else if (predType.includes("2.5Ãœ") && total >= 3) result = "won";
            else if (predType.includes("3.5Ãœ") && total >= 4) result = "won";
            else if (predType.includes("4.5Ãœ") && total >= 5) result = "won";
            else if (predType.includes("KGV") && homeScore > 0 && awayScore > 0) result = "won";
            
            if (result === "won") {
              shouldUpdateResult = true;
              shouldUpdateScore = true;
            }
          }
        }
        
        // 3. DATABASE UPDATE
        
        // Sadece skor gÃ¼ncelleme (result deÄŸiÅŸmez)
        if (shouldUpdateScore && !shouldUpdateResult) {
          await pool.query(
            'UPDATE predictions SET home_score = $1, away_score = $2, updated_at = NOW() WHERE id = $3',
            [homeScore, awayScore, pred.id]
          );
          scoreUpdated++;
          console.log(`ðŸ“Š Updated scores for #${pred.id}: ${homeScore}-${awayScore}`);
        }
        
        // Skor + result gÃ¼ncelleme
        if (shouldUpdateScore && shouldUpdateResult && result) {
          await pool.query(
            'UPDATE predictions SET home_score = $1, away_score = $2, status = $3, result = $4, completed_at = NOW(), updated_at = NOW() WHERE id = $5',
            [homeScore, awayScore, 'completed', result, pred.id]
          );
          updated++;
          console.log(`âœ… Completed #${pred.id}: ${result.toUpperCase()} (${homeScore}-${awayScore})`);
        }
      } catch (err) {
        console.error(`âŒ Error updating prediction #${pred.id}:`, err.message);
      }
    }

    console.log(`âœ… Cron job completed: ${updated} predictions completed, ${scoreUpdated} scores updated`);
    res.json({ success: true, updated, scoreUpdated, total: predictions.rows.length });
  } catch (error) {
    console.error('âŒ Update scores error:', error);
    res.status(500).json({ error: error.message });
  }
});

app.get('/health', async (req, res) => {
  try {
    await pool.query('SELECT 1');
    res.json({ 
      status: 'ok', 
      timestamp: new Date().toISOString(),
      database: 'connected'
    });
  } catch (error) {
    res.status(503).json({ 
      status: 'error', 
      timestamp: new Date().toISOString(),
      database: 'disconnected'
    });
  }
});

app.get('/', (req, res) => {
  res.json({
    name: 'FlashGoal API',
    version: '5.1.0-cleanup',
    status: 'production'
  });
});

